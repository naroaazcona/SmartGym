<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” SmartGym - Auth Service Test</title>
    <link rel="stylesheet" href="auth-service.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ‹ï¸â€â™‚ï¸ SmartGym</h1>
            <div class="subtitle">Auth Service - Panel de Pruebas</div>
        </header>

        <div class="service-status">
            <div>
                <strong>ğŸ” Auth Service</strong>
                <div>http://localhost:3001</div>
            </div>
            <div id="service-status" class="status-badge">Verificando...</div>
        </div>

        <!-- Health Check Section -->
        <div class="test-section">
            <h2>ğŸ¥ Health Check</h2>
            <p>Verifica que el servicio de autenticaciÃ³n estÃ© funcionando correctamente.</p>
            <button onclick="testHealth()" id="health-btn">Probar Health Check</button>
            <div id="health-result" class="result"></div>
        </div>

        <!-- Register Section -->
        <div class="test-section">
            <h2>ğŸ‘¤ Registro de Usuario</h2>
            <p>Crea una nueva cuenta en el sistema.</p>
            
            <div class="input-group">
                <label for="reg-email">Email:</label>
                <input type="email" id="reg-email" value="test@smartgym.com">
            </div>
            
            <div class="input-group">
                <label for="reg-password">ContraseÃ±a:</label>
                <input type="password" id="reg-password" value="test123">
            </div>
            
            <div class="input-group">
                <label for="reg-name">Nombre:</label>
                <input type="text" id="reg-name" value="Usuario Test">
            </div>

            <button onclick="register()" class="success">Registrar Usuario</button>
            <div id="register-result" class="result"></div>
        </div>

        <!-- Login Section -->
        <div class="test-section">
            <h2>ğŸ” Iniciar SesiÃ³n</h2>
            <p>Accede con una cuenta existente.</p>
            
            <div class="input-group">
                <label for="login-email">Email:</label>
                <input type="email" id="login-email" value="admin@smartgym.com">
            </div>
            
            <div class="input-group">
                <label for="login-password">ContraseÃ±a:</label>
                <input type="password" id="login-password" value="admin123">
            </div>

            <button onclick="login()" class="success">Iniciar SesiÃ³n</button>
            <button onclick="fillDemoUser()" class="secondary">Usuario Demo</button>
            <div id="login-result" class="result"></div>

            <div id="token-section" class="hidden">
                <h4>ğŸ”‘ Token JWT Obtenido:</h4>
                <div id="token-display" class="token-display"></div>
            </div>
        </div>

        <!-- Profile Section -->
        <div class="test-section">
            <h2>ğŸ“‹ Perfil de Usuario</h2>
            <p>ObtÃ©n la informaciÃ³n del perfil (requiere autenticaciÃ³n).</p>
            
            <button onclick="getProfile()" class="success">Obtener Perfil</button>
            <button onclick="clearToken()" class="danger">Limpiar Token</button>
            <div id="profile-result" class="result"></div>
        </div>

        <!-- Logout Section -->
        <div class="test-section">
            <h2>ğŸšª Cerrar SesiÃ³n</h2>
            <p>Cierra la sesiÃ³n actual del usuario.</p>
            <button onclick="logout()" class="danger">Cerrar SesiÃ³n</button>
        <div id="logout-result" class="result"></div>
</div>

        <!-- User Info Display -->
        <div id="user-info" class="user-info hidden">
            <h4>ğŸ‘¤ InformaciÃ³n del Usuario</h4>
            <div id="user-details"></div>
        </div>
    </div>

    <script>
    const BASE_URL = 'http://localhost:3001';

    const els = {
        status: document.getElementById('service-status'),
        healthBtn: document.getElementById('health-btn'),
        healthResult: document.getElementById('health-result'),
        regEmail: document.getElementById('reg-email'),
        regPassword: document.getElementById('reg-password'),
        regName: document.getElementById('reg-name'),
        registerResult: document.getElementById('register-result'),
        loginEmail: document.getElementById('login-email'),
        loginPassword: document.getElementById('login-password'),
        loginResult: document.getElementById('login-result'),
        profileResult: document.getElementById('profile-result'),
        tokenSection: document.getElementById('token-section'),
        tokenDisplay: document.getElementById('token-display'),
        userInfo: document.getElementById('user-info'),
        userDetails: document.getElementById('user-details'),
    };

    function setStatus(online) {
        els.status.textContent = online ? 'âœ… ONLINE' : 'âŒ OFFLINE';
        els.status.classList.toggle('offline', !online);
    }

    function printResult(el, data, ok = true) {
        el.classList.remove('success', 'error');
        el.classList.add(ok ? 'success' : 'error');
        el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    function getToken() { return localStorage.getItem('auth_token') || ''; }
    function setToken(token) {
        if (token) localStorage.setItem('auth_token', token);
        els.tokenSection.classList.remove('hidden');
        els.tokenDisplay.textContent = getToken();
    }
    function hideToken() {
        els.tokenSection.classList.add('hidden');
        els.tokenDisplay.textContent = '';
    }

    // VERIFICACIÃ“N TÃ‰CNICA MEJORADA
    async function checkServiceStatus() {
        try {
            const res = await fetch(`${BASE_URL}/health`);
            setStatus(res.ok);
        } catch (_) {
            setStatus(false);
        }
    }

    async function testHealth() {
        els.healthBtn.disabled = true;
        els.healthResult.textContent = 'ğŸ” Verificando conexiÃ³n a PostgreSQL y estado del servicio...';
        
        try {
            const startTime = Date.now();
            const res = await fetch(`${BASE_URL}/health`);
            const endTime = Date.now();
            const data = await res.json().catch(() => ({}));
            
            const healthAnalysis = `
ğŸ¥ HEALTH CHECK - ANÃLISIS TÃ‰CNICO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â±ï¸ Tiempo respuesta: ${endTime - startTime}ms
ğŸ“Š Estado: ${res.ok ? 'âœ… HEALTHY' : 'âŒ UNHEALTHY'}
ğŸ—„ï¸ Base de datos: ${data.database || 'No disponible'}

ğŸ”§ COMPONENTES VERIFICADOS:
${data.database === 'connected' ? 'âœ… PostgreSQL conectado' : 'âŒ PostgreSQL desconectado'}
${data.timestamp ? 'âœ… Timestamp funcionando' : 'âŒ Timestamp no disponible'}
${res.ok ? 'âœ… Endpoint /health accesible' : 'âŒ Endpoint /health no responde'}

ğŸ“‹ RESPUESTA COMPLETA:
${JSON.stringify(data, null, 2)}
            `;
            
            printResult(els.healthResult, healthAnalysis, res.ok);
            setStatus(res.ok);
        } catch (err) {
            const errorAnalysis = `
âŒ HEALTH CHECK FALLIDO - DIAGNÃ“STICO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Error: ${err.message}

ğŸ” POSIBLES CAUSAS:
â€¢ Auth Service no estÃ¡ ejecutÃ¡ndose
â€¢ Puerto 3001 bloqueado o en uso
â€¢ Error en app.js (express no iniciado)
â€¢ Problema de red o CORS
            `;
            printResult(els.healthResult, errorAnalysis, false);
            setStatus(false);
        } finally {
            els.healthBtn.disabled = false;
        }
    }

    async function register() {
        els.registerResult.textContent = 'ğŸ”¨ Creando usuario, hasheando password, generando JWT...';
        els.userInfo.classList.add('hidden');
        
        try {
            const body = {
                email: els.regEmail.value.trim(),
                password: els.regPassword.value,
                name: els.regName.value.trim(),
            };

            // Validaciones previas
            if (!body.email || !body.password || !body.name) {
                throw new Error('Faltan campos requeridos (email, password, name)');
            }

            if (body.password.length < 6) {
                throw new Error('La contraseÃ±a debe tener al menos 6 caracteres');
            }

            const startTime = Date.now();
            const res = await fetch(`${BASE_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            const endTime = Date.now();
            
            const data = await res.json().catch(() => ({}));

            if (res.ok) {
                // ANÃLISIS DETALLADO DEL REGISTRO EXITOSO
                const tokenParts = data.token.split('.');
                const payload = JSON.parse(atob(tokenParts[1]));
                
                const registerAnalysis = `
âœ… REGISTRO EXITOSO - VERIFICACIÃ“N TÃ‰CNICA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â±ï¸ Tiempo proceso: ${endTime - startTime}ms
ğŸ“Š Status: ${res.status} (CREATED)

ğŸ”§ COMPONENTES VERIFICADOS:
âœ… AuthController.register ejecutado
âœ… User.create() - Usuario guardado en PostgreSQL
âœ… bcrypt.hash() - Password hasheado correctamente
âœ… jwt.sign() - Token JWT generado
âœ… Middleware CORS funcionando

ğŸ‘¤ DATOS CREADOS:
â€¢ ID: ${data.user.id} (PostgreSQL SERIAL)
â€¢ Email: ${data.user.email} 
â€¢ Nombre: ${data.user.name}
â€¢ Rol: ${data.user.role} (valor por defecto)

ğŸ” TOKEN JWT ANALIZADO:
â€¢ Algoritmo: ${JSON.parse(atob(tokenParts[0])).alg}
â€¢ UserId en payload: ${payload.userId}
â€¢ Email en payload: ${payload.email}
â€¢ Rol en payload: ${payload.role}
â€¢ ExpiraciÃ³n: 24 horas

ğŸ“‹ RESPUESTA COMPLETA:
${JSON.stringify(data, null, 2)}
                `;
                
                printResult(els.registerResult, registerAnalysis, true);
                if (data.token) setToken(data.token);
            } else {
                const errorAnalysis = `
âŒ REGISTRO FALLIDO - ANÃLISIS TÃ‰CNICO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š Status: ${res.status}
ğŸ’¬ Error: ${data.error}

ğŸ” DIAGNÃ“STICO:
${data.error.includes('ya existe') ? 'âœ… User.findByEmail() funcionando - Email duplicado detectado' : ''}
${data.error.includes('contraseÃ±a') ? 'âœ… ValidaciÃ³n de password en controller funcionando' : ''}
${data.error.includes('requeridos') ? 'âœ… ValidaciÃ³n de campos en controller funcionando' : ''}
${res.status === 500 ? 'âŒ Error interno en User.create() o base de datos' : ''}
                `;
                printResult(els.registerResult, errorAnalysis, false);
            }
        } catch (err) {
            printResult(els.registerResult, `âŒ ERROR: ${err.message}`, false);
        }
    }

    async function login() {
        els.loginResult.textContent = 'ğŸ” Verificando credenciales, comparando passwords...';
        els.userInfo.classList.add('hidden');
        
        try {
            const body = {
                email: els.loginEmail.value.trim(),
                password: els.loginPassword.value,
            };

            if (!body.email || !body.password) {
                throw new Error('Email y password son requeridos');
            }

            const startTime = Date.now();
            const res = await fetch(`${BASE_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            const endTime = Date.now();
            
            const data = await res.json().catch(() => ({}));

            if (res.ok) {
                // ANÃLISIS DETALLADO DEL LOGIN EXITOSO
                const tokenParts = data.token.split('.');
                const payload = JSON.parse(atob(tokenParts[1]));
                
                const loginAnalysis = `
âœ… LOGIN EXITOSO - VERIFICACIÃ“N TÃ‰CNICA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â±ï¸ Tiempo autenticaciÃ³n: ${endTime - startTime}ms
ğŸ“Š Status: ${res.status} (OK)

ğŸ”§ COMPONENTES VERIFICADOS:
âœ… AuthController.login ejecutado
âœ… User.findByEmail() - Usuario encontrado en BD
âœ… User.verifyPassword() - bcrypt.compare() funcionando
âœ… jwt.sign() - Nuevo token generado

ğŸ” PROCESO DE AUTENTICACIÃ“N:
1. âœ… BÃºsqueda por email en PostgreSQL
2. âœ… ComparaciÃ³n password hasheado (bcrypt)
3. âœ… GeneraciÃ³n nuevo token JWT
4. âœ… Respuesta con datos usuario

ğŸ‘¤ USUARIO AUTENTICADO:
â€¢ ID: ${data.user.id}
â€¢ Email: ${data.user.email}
â€¢ Nombre: ${data.user.name}
â€¢ Rol: ${data.user.role}

ğŸ“‹ RESPUESTA COMPLETA:
${JSON.stringify(data, null, 2)}
                `;
                
                printResult(els.loginResult, loginAnalysis, true);
                if (data.token) setToken(data.token);
            } else {
                const errorAnalysis = `
âŒ LOGIN FALLIDO - ANÃLISIS TÃ‰CNICO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š Status: ${res.status}
ğŸ’¬ Error: ${data.error}

ğŸ” DIAGNÃ“STICO:
${res.status === 401 ? 'âœ… ValidaciÃ³n de credenciales funcionando - Usuario no existe o password incorrecto' : ''}
${res.status === 400 ? 'âœ… ValidaciÃ³n de campos requeridos funcionando' : ''}
${res.status === 500 ? 'âŒ Error interno en base de datos o JWT' : ''}
                `;
                printResult(els.loginResult, errorAnalysis, false);
            }
        } catch (err) {
            printResult(els.loginResult, `âŒ ERROR: ${err.message}`, false);
        }
    }

    function fillDemoUser() {
        els.loginEmail.value = 'admin@smartgym.com';
        els.loginPassword.value = 'admin123';
    }

    async function getProfile() {
        els.profileResult.textContent = 'ğŸ›¡ï¸ Verificando token JWT, consultando base de datos...';
        els.userInfo.classList.add('hidden');
        
        const token = getToken();
        if (!token) {
            printResult(els.profileResult, `
âŒ TOKEN NO ENCONTRADO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
El endpoint /profile requiere:
â€¢ Header: Authorization: Bearer <token>
â€¢ Token JWT vÃ¡lido y no expirado
â€¢ Middleware auth.js funcionando

ğŸ’¡ SoluciÃ³n: Inicia sesiÃ³n primero para obtener un token
            `, false);
            return;
        }

        try {
            const startTime = Date.now();
            const res = await fetch(`${BASE_URL}/profile`, {
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            const endTime = Date.now();
            
            const data = await res.json().catch(() => ({}));

            if (res.ok) {
                // ANÃLISIS DETALLADO DEL PROFILE EXITOSO
                const tokenParts = token.split('.');
                const payload = JSON.parse(atob(tokenParts[1]));
                
                const profileAnalysis = `
âœ… PERFIL OBTENIDO - VERIFICACIÃ“N TÃ‰CNICA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â±ï¸ Tiempo proceso: ${endTime - startTime}ms
ğŸ“Š Status: ${res.status} (OK)

ğŸ”§ COMPONENTES VERIFICADOS:
âœ… Middleware auth.js - Token validado
âœ… jwt.verify() - Token JWT verificado
âœ… User.findById() - Usuario encontrado en BD
âœ… AuthController.getProfile ejecutado

ğŸ›¡ï¸ PROCESO DE AUTORIZACIÃ“N:
1. âœ… Header Authorization recibido
2. âœ… Token JWT verificado y decodificado
3. âœ… userId extraÃ­do: ${payload.userId}
4. âœ… BÃºsqueda en PostgreSQL por ID
5. âœ… Datos usuario devueltos

ğŸ” VERIFICACIONES DE SEGURIDAD:
âœ… Token vÃ¡lido y no expirado
âœ… userId del token coincide con BD: ${payload.userId === data.user.id ? 'âœ… SÃ' : 'âŒ NO'}
âœ… Datos sensibles (password) ocultos

ğŸ‘¤ INFORMACIÃ“N DEL USUARIO:
${JSON.stringify(data.user, null, 2)}
                `;
                
                printResult(els.profileResult, profileAnalysis, true);
                if (data.user) {
                    els.userInfo.classList.remove('hidden');
                    els.userDetails.textContent = JSON.stringify(data.user, null, 2);
                }
            } else {
                const errorAnalysis = `
âŒ ERROR EN PERFIL - ANÃLISIS TÃ‰CNICO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š Status: ${res.status}
ğŸ’¬ Error: ${data.error}

ğŸ” DIAGNÃ“STICO:
${res.status === 401 ? 'âŒ Header Authorization faltante o mal formado' : ''}
${res.status === 403 ? 'âŒ Token JWT invÃ¡lido o expirado - jwt.verify() fallÃ³' : ''}
${res.status === 404 ? 'âŒ Usuario no encontrado en BD - User.findById() retornÃ³ null' : ''}
${res.status === 500 ? 'âŒ Error interno en base de datos o middleware' : ''}
                `;
                printResult(els.profileResult, errorAnalysis, false);
            }
        } catch (err) {
            printResult(els.profileResult, `âŒ ERROR: ${err.message}`, false);
        }
    }

    function clearToken() {
        localStorage.removeItem('auth_token');
        hideToken();
        els.userInfo.classList.add('hidden');
        els.profileResult.textContent = 'âœ… Token eliminado - Vuelve a iniciar sesiÃ³n para obtener uno nuevo';
    }

    // Exponer funciones a los botones inline
    window.testHealth = testHealth;
    window.register = register;
    window.login = login;
    window.fillDemoUser = fillDemoUser;
    window.getProfile = getProfile;
    window.clearToken = clearToken;

    document.addEventListener('DOMContentLoaded', () => {
        if (getToken()) setToken(getToken()); else hideToken();
        checkServiceStatus();
    });
    
    
    // ğŸ” NUEVO: FunciÃ³n para logout
    async function logout() {
        const logoutResult = document.getElementById('logout-result');
        const token = getToken();
        
        if (!token) {
            logoutResult.innerHTML = `
âŒ NO HAY SESIÃ“N ACTIVA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
No puedes cerrar sesiÃ³n porque:
â€¢ No hay token guardado en localStorage
â€¢ No has iniciado sesiÃ³n previamente
â€¢ La sesiÃ³n ya estaba cerrada

ğŸ’¡ SoluciÃ³n: Inicia sesiÃ³n primero
        `;
        logoutResult.classList.remove('success');
        logoutResult.classList.add('error');
        return;
    }

        logoutResult.textContent = 'ğŸ” Cerrando sesiÃ³n, verificando token...';
        
        try {
            const res = await fetch(`${BASE_URL}/logout`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`  // ğŸ” ENVIAR TOKEN
                }
            });
            
            const data = await res.json().catch(() => ({}));
            
            if (res.ok) {
                // Limpiar token localmente
                clearToken();
                logoutResult.innerHTML = `
âœ… LOGOUT EXITOSO - VERIFICACIÃ“N TÃ‰CNICA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š Status: ${res.status} (OK)

ğŸ”§ COMPONENTES VERIFICADOS:
âœ… Middleware auth.js - Token validado
âœ… AuthController.logout ejecutado
âœ… Token eliminado del localStorage
âœ… SesiÃ³n cerrada correctamente

ğŸ” PROCESO:
1. âœ… Token JWT verificado por middleware
2. âœ… Endpoint /logout ejecutado
3. âœ… Respuesta del servidor recibida
4. âœ… Token eliminado localmente

ğŸ“‹ RESPUESTA COMPLETA:
        ${JSON.stringify(data, null, 2)}
                    `;
                    logoutResult.classList.remove('error');
                    logoutResult.classList.add('success');
                } else {
                    const errorAnalysis = `
âŒ LOGOUT FALLIDO - ANÃLISIS TÃ‰CNICO
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“Š Status: ${res.status}
ğŸ’¬ Error: ${data.error}

ğŸ” DIAGNÃ“STICO:
${res.status === 401 ? 'âŒ Token no enviado en header Authorization' : ''}
${res.status === 403 ? 'âŒ Token JWT invÃ¡lido o expirado' : ''}
${res.status === 500 ? 'âŒ Error interno del servidor' : ''}
            `;
            logoutResult.innerHTML = errorAnalysis;
            logoutResult.classList.remove('success');
            logoutResult.classList.add('error');
        }
    } catch (err) {
        logoutResult.innerHTML = `
âŒ ERROR DE CONEXIÃ“N
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
No se pudo conectar al endpoint /logout
Error: ${err.message}

ğŸ” POSIBLES CAUSAS:
â€¢ Auth Service no estÃ¡ ejecutÃ¡ndose
â€¢ Problema de red
â€¢ Error CORS
        `;
        logoutResult.classList.remove('success');
        logoutResult.classList.add('error');
    }
} 
    </script>
</body>
</html>
